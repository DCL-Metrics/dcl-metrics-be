# there are a few branching paths that will determine data depth:
# 1. upcoming vs live vs completed - full data is only available for completed events after april 2022
# 2. worlds vs genesis city - worlds has less data
# 3. one_off vs recurrent - recurrent events have a slightly different structure
# so have to understand how to correctly pull data related to them

class Event
  def initialize(id)
    @id = id
    @url = "https://events.decentraland.org/api/events/#{id}"

    # initialize data
    data
  end

  def coordinates
    # TODO: should tap scene_disambiguation_uuid or estate_id to get all coordinates
    data['position'].join(',')
  end

  def duration_minutes
    data['duration'] / 1000 / 60
  end

  def date
    if one_off?
      DateTime.parse(start_time).to_date.to_s
    else
      # TODO
    end
  end

  def start_time
    data['start_at']
  end

  def end_time
    data['finish_at']
  end

  def recurrent?
    data['recurrent']
  end

  def one_off?
    !recurrent?
  end

  def live?
    data['live']
  end

  def world?
    data['world']
  end

  def genesis_city?
    !world?
  end

  def data
    return @data unless @data.nil?

    response = Faraday.get(url)
    @data = JSON.parse(response.body)['data']
  end

  private
  attr_reader :id, :url
end

current_event_id = 'a5033b5f-fce5-4685-ada5-5d33081d6c10'
past_event_id = '00cb4198-690a-4826-8127-192b60c8cc05'

e = Event.new(past_event_id)

# TODO: figure out date query, espeically in the case of events
# that span (1) only a few hours or (2) several days.
# TODO: if this event was in a world, query will look different and in both
# cases, the final result should be serialized
# TODO: will have to pull data points from backblaze to get precise data about
# what users were part of an event and which were not
# TODO: this should be find rather than where
pt = Models::ParcelTraffic.where(coordinates: e.coordinates).last

# can be nil
Models::DailySceneStats.where(scene_disambiguation_uuid: pt.scene_cid).first

# or get all other parcel traffic models
Models::ParcelTraffic.where(date: pt.date, scene_cid: pt.scene_cid)

